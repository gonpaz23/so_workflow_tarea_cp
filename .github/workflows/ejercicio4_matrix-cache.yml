name: Ejercicio 4 - Matriz y Cache

on: [push, workflow_dispatch]

jobs:
  test-matrix:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 18.x]
      # Evita que se cancelen todos si uno falla
      fail-fast: false
    
    steps:
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v3
    
    - name: Cache de dependencias npm
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Instalar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: InformaciÃ³n del sistema
      shell: bash
      run: |
        echo "=== INFORMACIÃ“N DEL SISTEMA ==="
        echo "Sistema Operativo: ${{ runner.os }}"
        echo "Node.js: ${{ matrix.node-version }}"
        echo "Directorio de trabajo: ${{ github.workspace }}"
        echo "Shell por defecto: ${{ runner.shell }}"
    
    - name: Ejecutar comandos especÃ­ficos por OS
      shell: bash
      run: |
        # Este script ahora es compatible porque usamos 'shell: bash'
        # incluso en Windows (GitHub incluye Git Bash)
        echo "ğŸ“ Contenido del directorio:"
        ls -la
        
        echo ""
        echo "ğŸ” Verificando sistema..."
        
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          echo "âœ… Ejecutando en Linux (Ubuntu)"
          echo "Comando de ejemplo:"
          uname -a
          
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "âœ… Ejecutando en Windows"
          echo "Comandos de Windows desde bash:"
          cmd.exe /c ver 2>/dev/null || echo "No se pudo obtener versiÃ³n de Windows"
          dir 2>/dev/null || echo "Comando 'dir' no disponible en bash"
          
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          echo "âœ… Ejecutando en macOS"
          echo "Comando de ejemplo:"
          sw_vers || echo "No se pudo obtener info de macOS"
          
        else
          echo "âš ï¸  Sistema operativo no reconocido"
        fi
    
    - name: Verificar Node.js funciona
      shell: bash
      run: |
        echo "ğŸ§ª Probando Node.js..."
        node --version
        npm --version
        
        # Crear y ejecutar un script simple de Node
        cat > test-node.js << 'EOF'
        console.log("âœ… Node.js funcionando correctamente en ${{ runner.os }}");
        console.log("VersiÃ³n de Node:", process.version);
        console.log("Plataforma:", process.platform);
        EOF
        
        node test-node.js
    
    - name: Finalizar con Ã©xito
      shell: bash
      run: |
        echo "ğŸ‰ Â¡Job completado exitosamente en ${{ runner.os }} con Node ${{ matrix.node-version }}!"